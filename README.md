# gcal-future-sync-script

## 概要

`gcal-future-sync-script` は、Google Apps Scriptで動作するスクリプトです。指定した複数のGoogleカレンダー（ソースカレンダー）から**今日以降の予定のみ**を取得し、別の指定した単一のGoogleカレンダー（デスティネーションカレンダー）へ定期的に同期します。

**主なユースケース:**

* Googleカレンダーの過去の予定はプライベートに保ちつつ、今後の予定だけを他者や別の目的（例: 共有用カレンダー、通知用カレンダー）に共有したい。
* ソースカレンダーの予定は編集させず、デスティネーションカレンダーでは閲覧のみを目的とする。
* このスクリプトは、新しい「共有用」カレンダーを作成し、そこに既存カレンダーの未来の予定を自動で同期させることで、上記のようなニーズを実現します。

**動作アルゴリズム:**

スクリプトが実行されると、以下の処理を行います。
1.  デスティネーションカレンダーに登録されている「今日から指定日数先まで」の全ての予定を削除します。
2.  ソースカレンダーから「今日以降で指定日数以内」の予定を取得し、デスティネーションカレンダーに新規作成します。（タイトルに指定の#nocopyが含まれる予定はコピーしません。）
3.  イベントの作成・削除時にGoogle Calendar APIのレート制限エラーが発生した場合、数回リトライ処理を行います。

## 設定方法

1.  **Google Apps Scriptエディタを開く**:
    * Googleドライブで「新規」>「その他」>「Google Apps Script」を選択します。
    * または、既存のGoogleスプレッドシートなどから「拡張機能」>「Apps Script」を選択します。
2.  **コードのコピー**:
    * このリポジトリにある `gcal-future-sync-script.gs` の内容をスクリプトエディタにコピー＆ペーストします。
3.  **設定値の構成**:
    * スクリプトエディタの左側メニュー「プロジェクトの設定」（歯車アイコン）>「スクリプト プロパティ」セクションで「スクリプト プロパティを編集」をクリックします。
    * 以下のキーと値を設定します。
        * `SOURCE_CALENDAR_IDS_CSV`: 同期元のカレンダーIDをカンマ区切りで入力（例: `id1@example.com,id2@example.com`）。
        * `DESTINATION_CALENDAR_ID`: 同期先のカレンダーID。
        * `DAYS_TO_SYNC`: 同期する日数（数値）。
4.  **初回実行と承認**:
    * スクリプトエディタの上部にある関数選択ドロップダウンから `simpleSyncCalendarEvents` を選択し、実行ボタン（▶）をクリックします。
    * 初回実行時には、スクリプトがGoogleカレンダーにアクセスするための承認を求められます。画面の指示に従って承認してください。（「このアプリは Google で確認されていません」と表示された場合は、「詳細」>「（プロジェクト名）に移動（安全ではありません）」と進んでください。）
5.  **定期実行トリガーの設定 (Google Apps Script Web UIから)**:
    * スクリプトエディタの左側メニューから「トリガー」（時計のアイコン）をクリックします。
    * 右下に表示される「トリガーを追加」ボタンをクリックします。
    * 以下の項目を設定します。
        * **実行する関数を選択**: `simpleSyncCalendarEvents`
        * **実行するデプロイを選択**: `Head` （通常はこれで問題ありません）
        * **イベントのソースを選択**: `時間主導型`
        * **時間ベースのトリガーのタイプを選択**: `日付ベースのタイマー` （毎日特定時刻に実行する場合）
        * **時刻を選択**: 任意（例: `午前 2 時～ 3 時`）
        * （必要に応じて）エラー通知設定: 「毎時」「毎日」など、エラー発生時の通知頻度を設定できます。
    * 「保存」ボタンをクリックします。

## カレンダーIDの確認方法

1.  Googleカレンダー ([https://calendar.google.com](https://calendar.google.com)) を開きます。
2.  左側の「マイカレンダー」または「他のカレンダー」セクションで、対象のカレンダーにマウスオーバーします。
3.  表示される縦の三点リーダー（オプション）をクリックし、「設定と共有」を選択します。
4.  左側のメニューから「カレンダーの統合」を選択すると、「カレンダー ID」という項目にIDが表示されています。

## 注意事項

* **権限**: スクリプトを実行するGoogleアカウントは、ソースカレンダーの読み取り権限と、デスティネーションカレンダーの編集権限（予定の作成・変更・削除）を持っている必要があります。
* **API割り当てとレート制限**: Google Apps Scriptには、1日の実行時間やAPI呼び出し回数に制限があります。このスクリプトにはAPIレート制限エラー発生時のリトライ処理が含まれていますが、それでも頻繁に制限に達する場合は、同期する日数 (`DAYS_TO_SYNC`) を調整するか、実行頻度を見直してください。
* **ログの確認**: スクリプトエディタの「実行数」ページで、定期実行のログを確認し、エラーが発生していないか監視することを推奨します。
* **初期設定の確認**: スクリプト内のカレンダーIDが初期値のまま (`YOUR_...`) になっていないか確認してください。
* **テスト**: 初めて使用する際は、テスト用のカレンダーで動作を確認することをお勧めします。
* **デスティネーションカレンダーのデータ**: このスクリプトは、実行のたびにデスティネーションカレンダーの指定期間内の予定を**全て削除**してからコピー処理を行います。デスティネーションカレンダーに手動で追加した予定も削除される点にご注意ください。

